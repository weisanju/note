# JAR File Specification

## Introduction

* JAR文件是一种基于流行的ZIP文件格式的文件格式，用于将许多文件聚合到一个文件中
* JAR文件本质上是一个zip文件，其中包含一个可选的META-INF目录。
* 可以从 *jar* 命令行创建 或者 使用  `java.util.jar` API
* jar包不仅用于存储jar文件，*META-INF* 如果存在，可以用于 存储包，扩展配置数据，例如：安全，版本控制，扩展和服务





## The META-INF directory

The following files/directories in the META-INF directory are recognized and interpreted by the Java 2 Platform to configure applications, extensions, class loaders and services:

`Java 2 Platform` 识别并解释了META-INF目录中的以下文件/目录，以配置应用程序，扩展，类加载器和服务

### **`MANIFEST.MF`**

The manifest file that is used to define extension and package related data.

### `INDEX.LIST`

> This file is generated by the new "`-i"` option of the jar tool

which contains location information for packages defined in an application or extension. 

It is part of the JarIndex implementation and used by class loaders to speed up their class loading process.

### `x.SF`

The signature file for the JAR file. 'x' stands for the base file name.

### `x.DSA`

The signature block file associated with the signature file with the same base file name. 

This file stores the digital signature of the corresponding signature file.

### `services/`

This directory stores all the service provider configuration files(SPI文件)

## Name-Value pairs and Sections

定义一些格式约定，在 *manifest* 清单、签名文件中的数据 以 `name: value` 键值对，受 `RFC822`启发

一组 键值对 叫 组，一个或多个空行 分隔组

二进制的数据以 base64表示，对于导致行长超过72个字节的二进制数据，需要连续进行。二进制数据的示例是摘要和签名。jar实现应支持最大65535字节的值。

**语法申明**

```
Specification:
  section:                       *header +newline
  nonempty-section:      +header +newline
  newline:                      CR LF | LF | CR (not followed by LF)
  header:                       name : value
  name:                         alphanum *headerchar
  value:                          SPACE *otherchar newline *continuation
  continuation:              SPACE *otherchar newline
  alphanum:                  {A-Z} | {a-z} | {0-9}
  headerchar:                alphanum | - | _
  otherchar:                  any UTF-8 character except NUL, CR and LF
; Also: To prevent mangling of files sent via straight e-mail, no
; header will start with the four letters "From".
```



## JAR Manifest

### Overview

jar文件 *manifest* 包含一个  主分区，以及跟随一系列 单独的 jar文件条目

*manifest* 清单的 主分区是指文件最先开始到 第一个空行

包括 安全和 jar本身的配置信息，还有组成jar所依赖的应用或扩展

主分区还定义了适用于每个单独清单条目的主要属性

此部分中的任何属性名称都不能等于“`Name`”。

其他 单独分区定义了各种各样的属性

并非JAR文件中的所有文件都需要在清单中作为条目列出，但必须列出所有要签名的文件。清单文件本身不能列出

每个分区 都必须以名称为“`Name`”的属性开头，该值必须是文件的相对路径，或者是引用外部数据的绝对URL。

申明多个单独分区且 文件entry是一样的，属性会合并，相同属性的最后一个会胜选

未知属性被忽略，可以由应用程序去实现

```
Manifest Specification:
  manifest-file:                    main-section newline *individual-section
  main-section:                    version-info newline *main-attribute
  version-info:                      Manifest-Version : version-number
  version-number :               digit+{.digit+}*
  main-attribute:                 (any legitimate main attribute) newline
  individual-section:             Name : value newline *perentry-attribute
  perentry-attribute:            (any legitimate perentry attribute) newline
  newline :                            CR LF | LF | CR (not followed by LF)
   digit:                                {0-9} 
```



*main-attribute* 指的是出现在 主分区中的 属性

*per-entry attribute* 指的是 出现在 独立分区中的属性

如果同时出现在main分区，和独立分区，则独立分区优先

### Main Attributes

**general main attributes** 

> 通用主属性

- Manifest-Version: 定义manifest的版本.
- Created-By: 定义这个jar文件是被哪一个*vendor* 实现的
- Signature-Version:  jar文件的签名版本
- Class-Path:此属性的值指定此应用程序或扩展程序需要的扩展程序或库的相对URL。URLs 由一个或多个空格分隔. 应用程序或扩展类加载器使用此属性的值来构造其内部搜索路径。

**attribute defined for stand-alone applications**

>独立应用程序,捆绑到可执行jar文件中的独立应用程序使用此属性组，java -jar x.jar

- Main-Class: Java启动类文件相对路径,必须有 .class 后缀

**attributes defined for applets** 

**attribute defined for extension identification**

**attributes defined for extension and package**

- Implementation-Title: The value is a string that defines the title of the extension implementation.
- Implementation-Version: The value is a string that defines the version of the extension implementation.
- Implementation-Vendor: The value is a string that defines the organization that maintains the extension implementation.
- Implementation-Vendor-Id: The value is a string id that uniquely defines the organization that maintains the extension implementation.
- Implementation-URL: This attribute defines the URL from which the extension implementation can be downloaded from.
- Specification-Title: The value is a string that defines the title of the extension specification.
- Specification-Version: The value is a string that defines the version of the extension specification.
- Specification-Vendor: The value is a string that defines the organization that maintains the extension specification.
- Sealed: This attribute defines whether this JAR file is sealed or not. The value can be either "true" or "false", case is ignored. If it is set to "true", then all the packages in the JAR file are defaulted to be sealed, unless they are defined otherwise individually.



### Per-Entry Attributes

**例如**

```
Manifest-Version: 1.0
Created-By: 1.2 (Sun Microsystems Inc.)
Sealed: true
Name: foo/bar/
Sealed: false
```

所有在a.jar中存档的软件包都是密封的 foo.bar除外

*per-entry attribute* 有以下配置组

**attributes defined for file contents:**

> 文件内容相关的属性

- Content-Type: 指定 文件的 MIME类型 值必须是 *type/subtype*. RFC [1521](ftp://www.ietf.org/rfc/rfc1521.txt) and [1522](ftp://www.ietf.org/rfc/rfc1522.txt) 对MIME类型进行了定义

**attributes defined for package versioning and sealing information**

> 包的版本控制与 封装信息

与 主分区 的属性一致，会覆盖主分区的同名属性

**attribute defined for beans objects**

> bean对象

- Java-Bean: 指定的jar文件条目是否为Java Beans对象. *true* 或 *false*

**attributes defined for signing**

> 签名与校验

- x-Digest-y: 此属性的值存储实际的摘要值. 前缀“ x”指定算法名称，可选的后缀“ y”表示摘要值应针对哪种语言进行验证。
- Magic: 这是一个可选属性，应用程序可以使用该属性来指示验证者应如何计算清单条目中包含的摘要值。
    此属性的值是一组用逗号分隔的上下文特定的字符串。

## Signed JAR File

A JAR file can be signed by using the command line [jarsigner](https://docs.oracle.com/javase/7/docs/technotes/guides/security/SecurityToolsSummary.html) tool or directly through the `java.security` API. Every file entry, including non-signature related files in the `META-INF` directory, will be signed if the JAR file is signed by the jarsigner tool. The signature related files are:

可以使用命令行， jarsigner 工具或直接通过`java.security` *API* 来对JAR文件进行签名。 
如果JAR文件由jarsigner工具签名，则每个文件条目（包括META-INF目录中与签名无关的文件）都将被签名。
与签名相关的文件是：

- `META-INF/MANIFEST.MF`
- `META-INF/*.SF`
- `META-INF/*.DSA`
- `META-INF/*.RSA`
- `META-INF/SIG-*`

如果此类文件位于“ META-INF”子目录中，则它们不被视为与签名相关。

这些文件名的不区分大小写的版本将被保留，也不会被签名。

可以使用java.security API对JAR文件的子集进行签名。

已签名的JAR文件与原始JAR文件完全相同，不同之处在于已更新其清单，并将两个附加文件添加到“ META-INF”目录中：签名文件和 *signature block file*。
当不使用jarsigner时，签名程序必须构造签名文件和签名块文件。

对于在签名的jar文件中签名的每个文件条目，只要清单中不存在该清单条目，就会为其创建一个单独的清单条目

每个清单条目 列出一个或多个 摘要属性

### Signature File

### Signature Validation

### The Magic Attribute

### Digital Signatures

### Notes on Manifest and Signature Files

## JAR Index

### Overview

**优化网络应用程序**

从1.3开始，引入JarIndex来优化网络应用程序（尤其是小应用程序）的类加载器的类搜索过程。
最初，小程序类加载器使用简单的线性搜索算法来搜索其内部搜索路径中的每个元素，该内部搜索路径是由“ ARCHIVE”标签或“ Class-Path”主属性构造的。
类加载器将下载并打开其搜索路径中的每个元素，直到找到该类或资源为止。
如果类加载器尝试查找不存在的资源，则必须下载应用程序或applet中的所有jar文件。
对于大型网络应用程序和小程序，这可能导致启动缓慢，响应缓慢以及网络带宽浪费。 
JarIndex机制收集小程序中定义的所有jar文件的内容，并将信息存储在小程序类路径上第一个jar文件的索引文件中。
在下载第一个jar文件之后，小应用程序类加载器将使用收集的内容信息来高效下载jar文件。

**Index.list**

现有的jar工具已得到增强，能够检查jar文件列表并生成有关哪些类和资源驻留在哪个jar文件中的目录信息。
该目录信息存储在根jar文件的META-INF目录中名为INDEX.LIST的简单文本文件中。
当类加载器加载根jar文件时，它将读取“ INDEX.LIST”文件，并使用它来构建从文件名和程序包名到jar文件名列表的映射的哈希表。
为了找到类或资源，类加载器查询哈希表以找到正确的jar文件，然后在必要时下载它。

***Index.list* 过时**

一旦类加载器在一个特定的jar文件中找到一个“ INDEX.LIST”文件，它就总是信任其中列出的信息。
如果找到特定类的映射，但类加载器无法通过跟踪链接找到它，则抛出*InvalidJarIndexException*
发生这种情况时，应用程序开发人员应在扩展名上重新运行“ jar”工具，以将正确的信息添加到索引文件中。

**文件尽量小**

为了防止给应用程序增加过多的空间开销并加快内存中哈希表的构建速度，INDEX.LIST文件应保持尽可能小。

* 对于具有非空程序包名称的类，映射记录在程序包级别。
    通常，一个程序包名称映射到一个jar文件，
* 但是如果一个特定的程序包跨越一个以上的jar文件，则此程序包的映射值将是jar文件列表。
* 对于具有非空目录前缀的资源文件，映射也记录在目录级别。
* 仅对于包名称为空的类以及位于根目录中的资源文件，映射将在单个文件级别记录。



### Index File Specification

INDEX.LIST文件包含一个或多个节，每个节由单个空白行分隔。
每个部分定义了一个特定jar文件的内容，其中的头定义了jar文件的路径名，后跟一个包或文件名的列表，每行一个。
所有的jar文件路径都相对于根jar文件的代码库。
这些路径名的解析方式与当前扩展机制对捆绑扩展名的解析方式相同。 
UTF-8编码用于支持索引文件中文件名或包名中的非ASCII字符。

## Service Provider

*META-INF/services* SPI 机制 详见 [SPI](../java基础/JavaSPI.md)







